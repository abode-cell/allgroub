
# مرحبًا بك في مشروعك!

## كود إعداد قاعدة البيانات في Supabase (النسخة النهائية)

**تعليمات:** انسخ كل الكود الموجود في هذا الصندوق، ثم اذهب إلى **SQL Editor** في لوحة تحكم Supabase، والصقه بالكامل، ثم اضغط على **RUN**.

```sql
-- ========= Drop Existing Objects (for a clean slate) =========
-- Stop the listener that might be using the functions
-- No explicit listener to stop, but dropping the trigger handles this.

-- Drop the trigger if it exists
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- Drop the function if it exists
DROP FUNCTION IF EXISTS public.handle_new_user;
DROP FUNCTION IF EXISTS public.get_user_data_and_context;
DROP FUNCTION IF EXISTS public.set_app_config;

-- Drop tables in reverse order of dependency
DROP TABLE IF EXISTS public.notifications;
DROP TABLE IF EXISTS public.support_tickets;
DROP TABLE IF EXISTS public.transactions;
DROP TABLE IF EXISTS public.borrowers;
DROP TABLE IF EXISTS public.investors;
DROP TABLE IF EXISTS public.branches;
DROP TABLE IF EXISTS public.app_config;
DROP TABLE IF EXISTS public.users;

-- Drop custom types
DROP TYPE IF EXISTS public.user_role;
DROP TYPE IF EXISTS public.user_status;

-- ========= Create Custom Types =========
CREATE TYPE public.user_role AS ENUM ('مدير النظام', 'مدير المكتب', 'مساعد مدير المكتب', 'موظف', 'مستثمر');
CREATE TYPE public.user_status AS ENUM ('نشط', 'معلق', 'مرفوض', 'محذوف');

-- ========= Create Tables =========

-- Users Table
CREATE TABLE public.users (
  id uuid NOT NULL PRIMARY KEY,
  name text,
  office_name text,
  email text UNIQUE,
  phone text UNIQUE,
  role user_role,
  status user_status DEFAULT 'معلق',
  managedBy uuid REFERENCES public.users(id) ON DELETE SET NULL,
  investorLimit integer DEFAULT 10,
  employeeLimit integer DEFAULT 5,
  assistantLimit integer DEFAULT 2,
  branchLimit integer DEFAULT 3,
  permissions jsonb,
  allowEmployeeSubmissions boolean DEFAULT false,
  hideEmployeeInvestorFunds boolean DEFAULT false,
  allowEmployeeLoanEdits boolean DEFAULT false,
  registrationDate timestamptz DEFAULT now(),
  trialEndsAt timestamptz
);

ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- Branches Table
CREATE TABLE public.branches (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  manager_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  name text NOT NULL,
  city text NOT NULL,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE public.branches ENABLE ROW LEVEL SECURITY;

-- Investors Table
CREATE TABLE public.investors (
  id uuid NOT NULL PRIMARY KEY REFERENCES public.users(id) ON DELETE CASCADE,
  name text,
  date timestamptz,
  status user_status DEFAULT 'معلق',
  submittedBy uuid REFERENCES public.users(id),
  rejectionReason text,
  isNotified boolean DEFAULT false,
  installmentProfitShare numeric,
  gracePeriodProfitShare numeric
);

ALTER TABLE public.investors ENABLE ROW LEVEL SECURITY;

-- Borrowers Table
CREATE TABLE public.borrowers (
  id text NOT NULL PRIMARY KEY,
  name text,
  nationalId text,
  phone text,
  amount numeric,
  rate numeric,
  term numeric,
  date timestamptz,
  loanType text,
  status text,
  dueDate date,
  discount numeric,
  submittedBy uuid REFERENCES public.users(id),
  rejectionReason text,
  fundedBy jsonb,
  paymentStatus text,
  installments jsonb,
  isNotified boolean,
  lastStatusChange timestamptz,
  paidOffDate timestamptz,
  partial_payment_paid_amount numeric,
  partial_payment_remaining_loan_id text,
  originalLoanId text
);

ALTER TABLE public.borrowers ENABLE ROW LEVEL SECURITY;

-- Transactions Table
CREATE TABLE public.transactions (
  id text NOT NULL PRIMARY KEY,
  investor_id uuid REFERENCES public.investors(id),
  date timestamptz,
  type text,
  amount numeric,
  description text,
  withdrawalMethod text,
  capitalSource text
);

ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;

-- Notifications Table
CREATE TABLE public.notifications (
  id text NOT NULL PRIMARY KEY,
  date timestamptz,
  recipientId uuid REFERENCES public.users(id),
  title text,
  description text,
  isRead boolean
);

ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

-- Support Tickets Table
CREATE TABLE public.support_tickets (
  id text NOT NULL PRIMARY KEY,
  date timestamptz,
  fromUserId uuid,
  fromUserName text,
  fromUserEmail text,
  subject text,
  message text,
  isRead boolean,
  isReplied boolean
);

ALTER TABLE public.support_tickets ENABLE ROW LEVEL SECURITY;

-- App Config Table
CREATE TABLE public.app_config (
  id bigint generated by default as identity primary key,
  key text unique not null,
  value jsonb not null
);

ALTER TABLE public.app_config ENABLE ROW LEVEL SECURITY;

-- ========= Insert Default Config Data =========
INSERT INTO public.app_config (key, value)
VALUES
  ('baseInterestRate', '{"value": 15}'::jsonb),
  ('investorSharePercentage', '{"value": 70}'::jsonb),
  ('salaryRepaymentPercentage', '{"value": 65}'::jsonb),
  ('graceTotalProfitPercentage', '{"value": 20}'::jsonb),
  ('graceInvestorSharePercentage', '{"value": 50}'::jsonb),
  ('supportEmail', '{"value": "support@example.com"}'::jsonb),
  ('supportPhone', '{"value": "920000000"}'::jsonb),
  ('defaultTrialPeriodDays', '{"value": 14}'::jsonb)
ON CONFLICT (key) DO NOTHING;

-- ========= Create Functions & Triggers =========

-- Function to handle new user creation
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  trial_days INT;
BEGIN
  -- Insert a new row into the public.users table
  INSERT INTO public.users (id, name, email, phone, role, status, managedBy, office_name)
  VALUES (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.email,
    new.raw_user_meta_data->>'raw_phone_number',
    (new.raw_user_meta_data->>'user_role')::user_role,
    'معلق', -- Always start as pending
    (new.raw_user_meta_data->>'managedBy')::uuid,
    new.raw_user_meta_data->>'office_name'
  );

  -- If the new user is an Office Manager, set their trial period
  IF (new.raw_user_meta_data->>'user_role')::user_role = 'مدير المكتب' THEN
    SELECT (value->>'value')::INT INTO trial_days FROM public.app_config WHERE key = 'defaultTrialPeriodDays';
    UPDATE public.users
    SET trialEndsAt = now() + (trial_days || ' days')::interval
    WHERE id = new.id;
  END IF;

  RETURN new;
END;
$$;

-- Trigger to call the function when a new auth user is created
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();


-- ========= Setup Row Level Security (RLS) Policies =========

-- USERS TABLE
CREATE POLICY "Allow system admin to manage all users" ON public.users FOR ALL USING ( (SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام' );
CREATE POLICY "Allow users to view their own data" ON public.users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Allow manager to view their team" ON public.users FOR SELECT USING (managedBy = auth.uid());
CREATE POLICY "Allow team members to view their manager" ON public.users FOR SELECT USING (id = (SELECT managedBy FROM public.users WHERE id = auth.uid()));
CREATE POLICY "Allow users to update their own data" ON public.users FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Allow managers to update their subordinates" ON public.users FOR UPDATE USING (EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('مدير المكتب', 'مساعد مدير المكتب') AND managedBy = auth.uid()));

-- INVESTORS TABLE
CREATE POLICY "Allow system admin to manage all investors" ON public.investors FOR ALL USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام');
CREATE POLICY "Allow users to manage their team investors" ON public.investors FOR ALL USING (EXISTS (SELECT 1 FROM users u WHERE u.id = investors.id AND u.managedBy = auth.uid()));
CREATE POLICY "Allow investors to view their own profile" ON public.investors FOR SELECT USING (auth.uid() = id);

-- BORROWERS TABLE
CREATE POLICY "Allow system admin to manage all borrowers" ON public.borrowers FOR ALL USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام');
CREATE POLICY "Allow team to manage their submitted borrowers" ON public.borrowers FOR ALL USING (EXISTS (SELECT 1 FROM users u WHERE u.id = borrowers.submittedBy AND (u.id = auth.uid() OR u.managedBy = auth.uid())));
CREATE POLICY "Allow investors to see loans they funded" ON public.borrowers FOR SELECT USING (fundedBy::text LIKE '%' || auth.uid()::text || '%');

-- TRANSACTIONS TABLE
CREATE POLICY "Allow system admin to see all transactions" ON public.transactions FOR ALL USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام');
CREATE POLICY "Allow investors to see their own transactions" ON public.transactions FOR SELECT USING (auth.uid() = investor_id);
CREATE POLICY "Allow managers to see their investors' transactions" ON public.transactions FOR SELECT USING (EXISTS (SELECT 1 FROM public.users u WHERE u.id = transactions.investor_id AND u.managedBy = auth.uid()));

-- NOTIFICATIONS TABLE
CREATE POLICY "Allow users to manage their own notifications" ON public.notifications FOR ALL USING (auth.uid() = recipientId);
CREATE POLICY "Allow server-side code to insert notifications" on public.notifications FOR INSERT WITH CHECK (true);

-- SUPPORT TICKETS TABLE
CREATE POLICY "Allow users to create support tickets" ON public.support_tickets FOR INSERT WITH CHECK (auth.uid() = fromUserId);
CREATE POLICY "Allow system admin to manage all tickets" ON public.support_tickets FOR ALL USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام');

-- APP CONFIG TABLE
CREATE POLICY "Allow authenticated users to read config" ON public.app_config FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow only System Admin to modify config" ON public.app_config FOR ALL USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'مدير النظام');

-- BRANCHES TABLE
CREATE POLICY "Allow manager to manage their own branches" ON public.branches FOR ALL USING (auth.uid() = manager_id);
CREATE POLICY "Allow subordinates to view their office branches" ON public.branches FOR SELECT USING (EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND managedBy = manager_id));

```
